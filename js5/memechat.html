<!DOCTYPE html>
<html lang="en">
<head>
    <title>Memechat</title>
    <style>
        .images1 {
            display: none;
        }
    </style>
</head>

<body>
<video class ="player" autoplay></video>
<input class="input" type="text" placeholder="Enter text for your meme prior to submitting"></input>
<button class="submit">Submit</button>
<canvas class="selfies"></canvas>
<div class="images1"></div>
<div class="images2"></div>
<script>
    const videoPlayer = document.querySelector('.player')
    const submit = document.querySelector('.submit')
    const canvas = document.querySelector('.selfies')
    const context = canvas.getContext('2d')
    const images1 = document.querySelector('.images1')
    const images2 = document.querySelector('.images2')
    const images = images1.querySelectorAll('.image')
    const input = document.querySelector('.input')

    const userCookie = ("; "+document.cookie).split("; username=").pop().split(";").shift()

    navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
    })
    .then(media => {
        videoPlayer.srcObject = media
    })

    const render = async () => {
        let count = 0
        images1.innerHTML = ''
        await fetch('/memechat/api/images', {
            method: 'GET',
            headers: {
                'content-type': 'applcation/json'
            }
        })
        .then(r=>r.json())
        .then(data => {
            console.log(data)
            const dataArray = Object.keys(data)
            dataArray.forEach(e => {
                const divider = document.createElement('div')
                divider.innerHTML = dataArray.reduce((acc, e) => {
                    return `${acc} <a href="${e}"><img style="width: 160px; height: 120px" src="/memechat/files/${e}.png?${Date.now}"></a>`
                })
                images1.append(divider)
            })
        })

        if(!images.length) {
            return setTimeout(() => {
                render()
            }, 1000)
        }

        images.forEach (image => image.addEventListener('load', () => {
            count = count + 1
            if (count != images.length) {
                return
            }
            images1.style.display = 'block'
            images2.style.display = 'none'

            const switcheroo = images2
            images2 = images1
            images1 = switcheroo

            setTimeout(() => {
                render()
            }, 1000)
        }))

    }

    submit.addEventListener('click', () => {
        context.drawImage(videoPlayer, 0, 0)
        const data = canvas.toDataURL().replace('data:image/png;base64,', '')
        fetch('/memechat', {
            method: 'POST',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                image: data,
                message: input.value,
                username: userCookie
            })
        })
        .then(r=>r.json())
        .then(() => input.value = '')
        .then(render())
    })
</script>
</body>
</html>